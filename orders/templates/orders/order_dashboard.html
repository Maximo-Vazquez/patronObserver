{% load static %}
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Estado del Pedido | Observador</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
    <style>
      /* --- Base y Fuentes --- */
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background-color: #f7f9fc; /* Fondo gris claro, similar al de la imagen */
        color: #1a1a1a; /* Texto oscuro */
      }
      
      /* Resetear contenedores para un layout limpio */
      .container {
          max-width: 800px; /* Ancho máximo para el contenido principal */
          padding-left: 1rem;
          padding-right: 1rem;
      }

      /* --- Estilo de la Cabecera Global (My Orders) --- */
      header {
          background-color: #ffffff;
          padding-top: 2rem;
          padding-bottom: 0.5rem;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); /* Sombra muy sutil */
          margin-bottom: 1.5rem;
      }
      
      header h1 {
          font-size: 2rem;
          font-weight: 700; /* Negrita como en la imagen */
          color: #1a1a1a;
          margin-bottom: 0.5rem;
      }
      
      /* --- Pestañas de Navegación (Tabs) --- */
      .tabs-navigation {
          display: flex;
          border-bottom: 1px solid #e0e0e0;
          margin-top: 1rem;
          padding-bottom: 0;
      }
      
      .tab {
          padding: 0.75rem 1.25rem;
          font-size: 1rem;
          font-weight: 500;
          color: #8c8c8c;
          cursor: pointer;
          border-bottom: 3px solid transparent;
          transition: color 0.2s, border-bottom-color 0.2s;
      }
      
      .tab-active {
          color: #27ae60; /* Verde principal para el activo */
          border-bottom-color: #27ae60;
          font-weight: 600;
      }
      
      /* --- Tarjeta del Pedido (Order Card) --- */
      .order-card {
          background-color: #ffffff;
          padding: 1.5rem;
          border-radius: 8px;
          box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
          margin-bottom: 2rem;
      }
      
      .order-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 1.5rem;
      }
      
      .order-info h2 {
          font-size: 1.25rem;
          font-weight: 600;
          color: #1a1a1a;
          margin: 0;
      }
      
      .order-info p {
          font-size: 1.1rem;
          font-weight: 700;
          color: #1a1a1a;
          margin: 0.25rem 0 0 0;
      }
      
      .order-actions a[role="button"] {
          /* Estilo del botón "Order Details" */
          background-color: #27ae60;
          color: white;
          border-radius: 6px;
          padding: 0.5rem 1rem;
          font-weight: 600;
          text-decoration: none;
          margin-left: 1rem;
          transition: background-color 0.2s;
      }
      
      .order-actions a[role="button"]:hover {
          background-color: #219d53;
      }
      
      .order-actions a.cancel-link {
          /* Estilo del enlace "Cancel Order" */
          color: #e74c3c;
          font-weight: 600;
          text-decoration: none;
          margin-left: 1rem;
          transition: color 0.2s;
      }

      .order-actions a.cancel-link:hover {
          color: #c0392b;
      }
      
      /* --- Barra de Progreso (Timeline) - Simplificada --- */
      .timeline {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 1rem;
          position: relative;
          padding: 0 0.5rem;
      }
      
      .timeline-step {
          text-align: center;
          flex-grow: 1;
          color: #8c8c8c;
          font-size: 0.85rem;
          font-weight: 500;
          z-index: 10;
          /* Usamos flexbox para que los labels queden abajo de los círculos */
          display: flex;
          flex-direction: column; 
          align-items: center;
      }
      
      .timeline-circle {
          width: 16px; /* Aumentamos el tamaño */
          height: 16px;
          background-color: #dcdcdc; /* Gris inactivo */
          border-radius: 50%;
          margin-bottom: 0.4rem;
          transition: background-color 0.3s ease;
          position: relative;
          z-index: 20;
          display: flex;
          align-items: center;
          justify-content: center;
      }
      
      .timeline-line {
          position: absolute;
          top: 7px; /* Altura del centro del círculo */
          left: 0;
          right: 0;
          height: 2px;
          background-color: #dcdcdc; /* Línea inactiva */
          z-index: 10;
          margin: 0 1.5rem; /* Separar la línea de los círculos de los extremos */
      }
      
      .timeline-line-progress {
          position: absolute;
          top: 0;
          left: 0;
          height: 100%;
          width: 0%; 
          background-color: #27ae60;
          transition: width 0.5s ease-out;
          z-index: 15;
      }
      
      .step-completed .timeline-circle {
          background-color: #27ae60; /* Verde activo/completado */
          color: white;
      }
      
      .step-completed .timeline-circle .material-symbols-outlined {
          font-size: 0.75rem;
      }

      .step-completed .timeline-label {
          color: #1a1a1a;
          font-weight: 600;
      }
      
      /* Estilo para el ícono de checkmark solo para pasos completados */
      .timeline-circle .material-symbols-outlined {
          display: none; /* Ocultar por defecto */
      }
      .step-completed .timeline-circle .material-symbols-outlined {
          display: block; /* Mostrar solo cuando está completado */
      }
      
      /* Información adicional debajo de la línea de tiempo */
      .order-metadata {
          display: flex;
          gap: 1rem;
          margin-top: 1.5rem;
          font-size: 0.9rem;
          color: #555555;
          flex-wrap: wrap; 
      }
      
      .order-metadata span {
          display: flex;
          align-items: center;
          gap: 0.25rem;
      }
      
      .order-metadata span:before {
          content: '•';
          color: #27ae60;
          font-weight: bold;
      }
      
      /* --- Estilo de la Tabla de Productos (Rediseñada) --- */
      .product-details {
          margin-top: 2rem;
      }
      
      .product-details h2 {
          font-size: 1.5rem;
          font-weight: 600;
          margin-bottom: 1rem;
          color: #1a1a1a;
      }

      /* Estilos para la tabla */
      .product-details table {
          width: 100%;
          border-collapse: collapse;
          --pico-font-size: 0.95rem;
          border-radius: 8px;
          overflow: hidden;
          background-color: #ffffff;
          box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      }
      
      .product-details table thead th {
          background-color: #f0f0f0;
          color: #555555;
          font-weight: 600;
          text-align: left;
          padding: 1rem;
          border: none;
      }
      
      .product-details table tbody td {
          padding: 1rem;
          border-top: 1px solid #eeeeee;
          color: #333333;
      }
      
      .product-details table tbody tr:nth-child(even) {
          background-color: #f9f9f9;
      }

      .product-details table tfoot {
          background-color: #ffffff; /* Aseguramos fondo blanco */
          border-top: 2px solid #27ae60; /* Separador */
      }

      .product-details table tfoot th,
      .product-details table tfoot td {
          font-size: 1.1em;
          padding: 1rem;
          color: #1a1a1a;
      }
      
      .product-details table tfoot strong {
          color: #27ae60;
          font-weight: 700;
      }

    </style>
  </head>
  <body>
    <header>
      <div class="container">
        <h1>My Orders</h1>
        
        <div class="tabs-navigation">
            <div class="tab tab-active">Upcoming Orders (1)</div>
            <div class="tab">Previous Orders (0)</div>
            <div class="tab">Scheduled Orders (0)</div>
        </div>
      </div>
    </header>

    <main class="container">
      <article class="order-card">
        
        <div class="order-header">
            <img src="{% static 'app_icon.png' %}" alt="App Icon" style="width: 32px; height: 32px; margin-right: 1rem; float: left;">
            <div class="order-info" style="flex-grow: 1;">
                <h2>Order no #1125</h2> 
                <p>EGP 213.00</p>
            </div>
            <div class="order-actions">
                <a href="#" role="button">Order Details</a>
                <a href="#" class="cancel-link">Cancel Order</a>
            </div>
        </div>

        <div class="timeline">
            <div class="timeline-line"><div class="timeline-line-progress" id="timeline-progress"></div></div>

            <div class="timeline-step" id="step-preparing">
                <div class="timeline-circle"><span class="material-symbols-outlined">done</span></div>
                <div class="timeline-label">Preparing</div>
            </div>
            
            <div class="timeline-step" id="step-out_for_delivery">
                <div class="timeline-circle"><span class="material-symbols-outlined">done</span></div>
                <div class="timeline-label">En camino</div>
            </div>
            
            <div class="timeline-step" id="step-delivered">
                <div class="timeline-circle"><span class="material-symbols-outlined">done</span></div>
                <div class="timeline-label">Delivered</div>
            </div>
        </div>

        <div class="order-metadata">
            <span>2 Items</span>
            <span>Cash on Delivery</span>
            <span id="order-time-ago">Ordered 2 mins ago</span>
            <span>Delivery within 25 mins</span>
        </div>

      </article>



    </main>

    <footer class="container" style="margin-top: 2rem;">
      <small style="color: #8c8c8c; display: block; text-align: center;">
        Visualización del estado del pedido en tiempo real.
        <a href="{% url 'order-control' %}" style="margin-left: 1rem; color: #27ae60; text-decoration: none;">Ir al panel de control</a>.
      </small>
    </footer>

    <script>
      // Mapeo de estados de Django a los IDs de los pasos
      // Asumiendo que el backend envía: 'preparing', 'out_for_delivery', 'delivered'
      const statusMap = {
          'preparing': 'step-preparing',
          'out_for_delivery': 'step-out_for_delivery', // 'En camino'
          'delivered': 'step-delivered',
          // Cualquier otro estado (e.g., 'created', 'cancelled') no avanzará el progreso visual.
      };
      
      // La lista ordenada de 3 estados para calcular el progreso
      const orderedStatuses = ['preparing', 'out_for_delivery', 'delivered'];

      function updateTimeline(currentStatus) {
        const progressLine = document.getElementById('timeline-progress');
        let currentStepIndex = orderedStatuses.indexOf(currentStatus);
        
        let progressPercent = 0;
        
        // Hay 3 pasos, lo que significa 2 transiciones (0% -> 50% -> 100%)
        const segments = orderedStatuses.length - 1; 

        if (currentStepIndex >= 0) {
            if (currentStepIndex === segments) {
                // Estado 'delivered' (índice 2): 100%
                progressPercent = 100;
            } else if (currentStepIndex === 0) {
                // Estado 'preparing' (índice 0): 0% (el primer paso no tiene línea antes)
                progressPercent = 0;
            } else {
                // Estado 'out_for_delivery' (índice 1): 50%
                progressPercent = (currentStepIndex * 100) / segments;
            }
        }
        
        // El progreso visual es ligeramente diferente: 
        // Si es 'preparing', queremos que el círculo 1 esté verde, pero la línea en 0%.
        // Si es 'out_for_delivery', queremos que el círculo 1 y 2 estén verdes, y la línea en 50%.
        // Si es 'delivered', queremos todo verde y la línea en 100%.

        // El cálculo de la línea debe ser:
        // 'preparing' (index 0) -> 0%
        // 'out_for_delivery' (index 1) -> 50%
        // 'delivered' (index 2) -> 100%
        progressPercent = currentStepIndex * 50; 
        
        progressLine.style.width = `${progressPercent}%`;

        // Iterar sobre todos los pasos para aplicar clases
        orderedStatuses.forEach((status, index) => {
            const stepId = statusMap[status];
            const stepElement = document.getElementById(stepId);
            
            if (!stepElement) return;

            // 1. Resetear clases
            stepElement.classList.remove('step-completed');
            
            // 2. Aplicar 'completed' para los pasos hasta el actual (inclusive)
            if (index <= currentStepIndex) {
                stepElement.classList.add('step-completed');
            }
        });
      }
      
      // Función para simular el tiempo transcurrido (estático, pero mejora el detalle)
      function updateOrderTime(orderTimestamp) {
          // Si tu backend envía el timestamp real, úsalo aquí.
          // Por ahora, solo muestra el texto estático del diseño de la foto.
          document.getElementById('order-time-ago').textContent = 'Ordered 2 mins ago';
      }

      async function fetchStatus() {
        try {
            // Lógica de la llamada API
            const response = await fetch("{% url 'order-status-data' %}");
            if (!response.ok) throw new Error("Network response was not ok.");

            const data = await response.json();
            
            // Actualizar la barra de progreso con el estado raw ('preparing', 'out_for_delivery', etc.)
            updateTimeline(data.status); 

        } catch (error) {
            console.error("Error al cargar o actualizar estado:", error);
        }
      }

      // Inicializar y configurar el intervalo de polling
      // Llama a fetchStatus una vez al cargar y luego cada 2 segundos
      fetchStatus();
      setInterval(fetchStatus, 2000); // <-- Cambiado a 2000ms (2 segundos)
    </script>
  </body>
</html>