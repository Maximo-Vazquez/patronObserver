{% load static %}
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Estado del Pedido | Observador</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
    <style>
      /* --- Base y Fuentes --- */
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background-color: #f7f9fc; /* Fondo gris claro, similar al de la imagen */
        color: #1a1a1a; /* Texto oscuro */
      }
      
      /* Resetear contenedores para un layout limpio */
      .container {
          max-width: 800px; /* Ancho máximo para el contenido principal */
          padding-left: 1rem;
          padding-right: 1rem;
      }

      /* --- Estilo de la Cabecera Global (Mis Pedidos) --- */
      header {
          background-color: #ffffff;
          padding-top: 2rem;
          padding-bottom: 0.5rem;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); /* Sombra muy sutil */
          margin-bottom: 1.5rem;
      }
      
      header h1 {
          font-size: 2rem;
          font-weight: 700; /* Negrita como en la imagen */
          color: #1a1a1a;
          margin-bottom: 0.5rem;
      }
      
      /* --- Pestañas de Navegación (Tabs) --- */
      .tabs-navigation {
          display: flex;
          border-bottom: 1px solid #e0e0e0;
          margin-top: 1rem;
          padding-bottom: 0;
      }
      
      .tab {
          padding: 0.75rem 1.25rem;
          font-size: 1rem;
          font-weight: 500;
          color: #8c8c8c;
          cursor: pointer;
          border-bottom: 3px solid transparent;
          transition: color 0.2s, border-bottom-color 0.2s;
      }
      
      .tab-active {
          color: #27ae60; /* Verde principal para el activo */
          border-bottom-color: #27ae60;
          font-weight: 600;
      }
      
      /* --- Tarjeta del Pedido (Order Card) --- */
      .order-card {
          background-color: #ffffff;
          padding: 1.5rem;
          border-radius: 8px;
          box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
          margin-bottom: 2rem;
      }
      
      .order-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 1.5rem;
      }
      
      .order-info h2 {
          font-size: 1.25rem;
          font-weight: 600;
          color: #1a1a1a;
          margin: 0;
      }
      
      .order-info p {
          font-size: 1.1rem;
          font-weight: 700;
          color: #1a1a1a;
          margin: 0.25rem 0 0 0;
      }
      
      .order-actions a[role="button"] {
          /* Estilo del botón "Detalles del Pedido" */
          background-color: #27ae60;
          color: white;
          border-radius: 6px;
          padding: 0.5rem 1rem;
          font-weight: 600;
          text-decoration: none;
          margin-left: 1rem;
          transition: background-color 0.2s;
      }
      
      .order-actions a[role="button"]:hover {
          background-color: #219d53;
      }
      
      .order-actions a.cancel-link {
          /* Estilo del enlace "Cancelar Pedido" */
          color: #e74c3c;
          font-weight: 600;
          text-decoration: none;
          margin-left: 1rem;
          transition: color 0.2s;
      }

      .order-actions a.cancel-link:hover {
          color: #c0392b;
      }
      
      /* --- Barra de Progreso (Línea de Tiempo) - Simplificada --- */
      .timeline {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 1rem;
          position: relative;
          padding: 0 0.5rem;
      }
      
      .timeline-step {
          text-align: center;
          flex-grow: 1;
          color: #8c8c8c;
          font-size: 0.85rem;
          font-weight: 500;
          z-index: 10;
          /* Usamos flexbox para que los labels queden abajo de los círculos */
          display: flex; 
          flex-direction: column; 
          align-items: center;
      }
      
      .timeline-circle {
          width: 16px; /* Aumentamos el tamaño */
          height: 16px;
          background-color: #dcdcdc; /* Gris inactivo */
          border-radius: 50%;
          margin-bottom: 0.4rem;
          transition: background-color 0.3s ease;
          position: relative;
          z-index: 20;
          display: flex;
          align-items: center;
          justify-content: center;
      }
      
      .timeline-line {
          position: absolute;
          top: 7px; /* Altura del centro del círculo */
          left: 0;
          right: 0;
          height: 2px;
          background-color: #dcdcdc; /* Línea inactiva */
          z-index: 10;
          margin: 0 1.5rem; /* Separar la línea de los círculos de los extremos */
      }
      
      .timeline-line-progress {
          position: absolute;
          top: 0;
          left: 0;
          height: 100%;
          width: 0%; 
          background-color: #27ae60;
          transition: width 0.5s ease-out;
          z-index: 15;
      }
      
      .step-completed .timeline-circle {
          background-color: #27ae60; /* Verde activo/completado */
          color: white;
      }
      
      .step-completed .timeline-circle .material-symbols-outlined {
          font-size: 0.75rem;
      }

      .step-completed .timeline-label {
          color: #1a1a1a;
          font-weight: 600;
      }
      
      /* Estilo para el ícono de checkmark solo para pasos completados */
      .timeline-circle .material-symbols-outlined {
          display: none; /* Ocultar por defecto */
      }
      .step-completed .timeline-circle .material-symbols-outlined {
          display: block; /* Mostrar solo cuando está completado */
      }
      
      /* Información adicional debajo de la línea de tiempo */
      .order-metadata {
          display: flex;
          gap: 1rem;
          margin-top: 1.5rem;
          font-size: 0.9rem;
          color: #555555;
          flex-wrap: wrap; 
      }
      
      .order-metadata span {
          display: flex;
          align-items: center;
          gap: 0.25rem;
      }
      
      .order-metadata span:before {
          content: '•';
          color: #27ae60;
          font-weight: bold;
      }
      
      /* --- Estilo de la Tabla de Productos (Rediseñada) --- */
      .product-details {
          margin-top: 2rem;
      }
      
      .product-details h2 {
          font-size: 1.5rem;
          font-weight: 600;
          margin-bottom: 1rem;
          color: #1a1a1a;
      }

      /* Estilos para la tabla */
      .product-details table {
          width: 100%;
          border-collapse: collapse;
          --pico-font-size: 0.95rem;
          border-radius: 8px;
          overflow: hidden;
          background-color: #ffffff;
          box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      }
      
      .product-details table thead th {
          background-color: #f0f0f0;
          color: #555555;
          font-weight: 600;
          text-align: left;
          padding: 1rem;
          border: none;
      }
      
      .product-details table tbody td {
          padding: 1rem;
          border-top: 1px solid #eeeeee;
          color: #333333;
      }
      
      .product-details table tbody tr:nth-child(even) {
          background-color: #f9f9f9;
      }

      .product-details table tfoot {
          background-color: #ffffff; /* Aseguramos fondo blanco */
          border-top: 2px solid #27ae60; /* Separador */
      }

      .product-details table tfoot th,
      .product-details table tfoot td {
          font-size: 1.1em;
          padding: 1rem;
          color: #1a1a1a;
      }
      
      .product-details table tfoot strong {
          color: #27ae60;
          font-weight: 700;
      }

    </style>
  </head>
  <body>
    <header>
      <div class="container">
        <h1>Mis Pedidos</h1>
        
        <div class="tabs-navigation">
            <div class="tab tab-active">Pedidos Próximos (1)</div>
            <div class="tab">Pedidos Anteriores (0)</div>
            <div class="tab">Pedidos Programados (0)</div>
        </div>
      </div>
    </header>

    <main class="container">
      <article class="order-card">
        
        <div class="order-header">
            <img src="{% static 'app_icon.png' %}" alt="Icono de la Aplicación" style="width: 32px; height: 32px; margin-right: 1rem; float: left;">
            <div class="order-info" style="flex-grow: 1;">
                <h2>Pedido n.º #{% if pedido.pk %}{{ pedido.pk|stringformat:"04d" }}{% else %}—{% endif %}</h2>
                <p>{{ moneda }} {{ total_pedido|floatformat:2 }}</p>
            </div>
            <div class="order-actions">
                <a href="#" role="button">Detalles del Pedido</a>
                <a href="#" class="cancel-link">Cancelar Pedido</a>
            </div>
        </div>

        <div class="timeline" data-estado-inicial="{{ pedido.status }}" role="list" aria-label="Estado del pedido">
            <div class="timeline-line"><div class="timeline-line-progress" id="progreso-linea-tiempo"></div></div>

            {% for value, label in opciones_estado %}
            <div class="timeline-step" data-estado="{{ value }}" role="listitem">
                <div class="timeline-circle"><span class="material-symbols-outlined">done</span></div>
                <div class="timeline-label">{{ label }}</div>
            </div>
            {% endfor %}
        </div>

        <div class="order-metadata">
            <span>{{ total_articulos }} artículo{% if total_articulos != 1 %}s{% endif %}</span>
            <span>Pago contra Reembolso</span>
            <span id="tiempo-transcurrido">Actualizado hace {{ pedido.updated_at|timesince }}</span>
            <span id="etiqueta-estado-actual">Estado actual: {{ pedido.get_status_display }}</span>
        </div>

        <section class="product-details">
            <h2>Resumen de productos</h2>
            <table role="grid">
                <thead>
                    <tr>
                        <th scope="col">Producto</th>
                        <th scope="col">SKU</th>
                        <th scope="col">Cantidad</th>
                        <th scope="col">Precio unitario</th>
                        <th scope="col">Subtotal</th>
                    </tr>
                </thead>
                <tbody>
                    {% for producto in productos %}
                    <tr>
                        <td>{{ producto.nombre }}</td>
                        <td>{{ producto.sku }}</td>
                        <td>{{ producto.cantidad }}</td>
                        <td>{{ moneda }} {{ producto.precio|floatformat:2 }}</td>
                        <td>{{ moneda }} {{ producto.subtotal|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr>
                        <th scope="row" colspan="4">Total del pedido</th>
                        <td><strong>{{ moneda }} {{ total_pedido|floatformat:2 }}</strong></td>
                    </tr>
                </tfoot>
            </table>
        </section>

      </article>



    </main>

    <footer class="container" style="margin-top: 2rem;">
      <small style="color: #8c8c8c; display: block; text-align: center;">
        Visualización del estado del pedido en tiempo real.
        <a href="{% url 'order-control' %}" style="margin-left: 1rem; color: #27ae60; text-decoration: none;">Ir al panel de control</a>.
      </small>
    </footer>
    
    </body>
    <script>
    const pasosLineaTiempo = Array.from(document.querySelectorAll('.timeline-step'));
    const estadosOrdenados = pasosLineaTiempo.map((paso) => paso.dataset.estado);
    const lineaProgreso = document.getElementById('progreso-linea-tiempo');
    const etiquetaEstadoActual = document.getElementById('etiqueta-estado-actual');

    function actualizarLineaTiempo(estadoActual) {
      if (!lineaProgreso || estadosOrdenados.length === 0) {
        return;
      }

      const totalSegmentos = Math.max(estadosOrdenados.length - 1, 1);
      const indiceEncontrado = estadosOrdenados.indexOf(estadoActual);
      const indicePasoActual = indiceEncontrado;
      const progresoIndice = Math.min(Math.max(indiceEncontrado, 0), totalSegmentos);
      const progresoPorcentaje = totalSegmentos === 0 ? 100 : (progresoIndice / totalSegmentos) * 100;

      lineaProgreso.style.width = `${progresoPorcentaje}%`;

      pasosLineaTiempo.forEach((paso, indice) => {
        const completado = indicePasoActual >= 0 && indice <= indicePasoActual;
        paso.classList.toggle('step-completed', completado);
      });
    }

    function actualizarTiempoPedido(actualizacionIso) {
        if (!actualizacionIso) {
            return;
        }

        const elementoTiempo = document.getElementById('tiempo-transcurrido');
        if (!elementoTiempo) {
            return;
        }

        const actualizado = new Date(actualizacionIso);
        const ahora = new Date();
        const diferenciaMs = Math.max(ahora.getTime() - actualizado.getTime(), 0);
        const minutos = Math.floor(diferenciaMs / 60000);

        if (minutos <= 0) {
            elementoTiempo.textContent = 'Actualizado hace un instante';
            return;
        }

        const sufijo = minutos === 1 ? '' : 's';
        elementoTiempo.textContent = `Actualizado hace ${minutos} minuto${sufijo}`;
    }

    function actualizarEtiquetaEstado(descripcionEstado) {
        if (!etiquetaEstadoActual) {
            return;
        }
        etiquetaEstadoActual.textContent = `Estado actual: ${descripcionEstado}`;
    }

    function procesarSeguimiento(datos) {
        actualizarLineaTiempo(datos.estado);
        actualizarTiempoPedido(datos.actualizado);
        actualizarEtiquetaEstado(datos.descripcion_estado);
    }

    const lineaTiempoElemento = document.querySelector('.timeline');
    const estadoInicial = lineaTiempoElemento?.dataset.estadoInicial ?? null;
    actualizarLineaTiempo(estadoInicial);
    actualizarTiempoPedido("{{ pedido.updated_at|date:'c' }}");
    actualizarEtiquetaEstado("{{ pedido.get_status_display }}");

    const protocoloWebSocket = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const identificadorPedido = '{{ pedido.pk }}';
    if (identificadorPedido && identificadorPedido !== 'None') {
        const direccionWebSocket = `${protocoloWebSocket}://${window.location.host}/ws/pedidos/${identificadorPedido}/`;
        const conexionSeguimiento = new WebSocket(direccionWebSocket);

        conexionSeguimiento.addEventListener('message', (evento) => {
            try {
                const datos = JSON.parse(evento.data);
                if (datos?.tipo !== 'seguimiento') {
                    return;
                }
                procesarSeguimiento(datos);
            } catch (error) {
                console.error('No fue posible interpretar el mensaje recibido:', error);
            }
        });

        conexionSeguimiento.addEventListener('error', (error) => {
            console.error('Error en la conexión de seguimiento del pedido:', error);
        });
    }
</script>
</html>