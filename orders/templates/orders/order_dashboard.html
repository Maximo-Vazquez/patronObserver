{% load static %}
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Panel del pedido | Observador</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
    <style>
      body {
        background: radial-gradient(circle at top, #f3f7ff 0%, #ffffff 55%);
        min-height: 100vh;
        padding: 2.5rem 0 4rem;
      }

      .material-symbols-outlined {
        font-variation-settings:
          "FILL" 0,
          "wght" 600,
          "GRAD" 0,
          "opsz" 24;
        font-size: 1.25rem;
      }

      header {
        margin-bottom: 2rem;
      }

      .layout {
        display: grid;
        gap: 2rem;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        align-items: start;
      }

      .card {
        padding: 2rem;
        border-radius: 18px;
        background-color: #ffffff;
        box-shadow: 0 25px 45px rgba(15, 40, 85, 0.08);
        border: 1px solid rgba(15, 40, 85, 0.08);
      }

      .status-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
        background: #1b64f2;
        color: #ffffff;
      }

      .status-track {
        list-style: none;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        margin: 0;
        padding: 0;
      }

      .status-track li {
        display: grid;
        grid-template-columns: 40px 1fr;
        gap: 1rem;
        align-items: center;
      }

      .status-track .bullet {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: grid;
        place-items: center;
        font-weight: 600;
        border: 2px solid #d6def5;
        color: #7a88b8;
      }

      .status-track li.reached .bullet {
        background: #1b64f2;
        color: #ffffff;
        border-color: #1b64f2;
      }

      .status-track li.reached .label {
        color: #102b6a;
        font-weight: 600;
      }

      .status-track li:not(.reached) .label {
        color: #7a88b8;
      }

      .status-track .label small {
        display: block;
        color: inherit;
        font-weight: 400;
        opacity: 0.8;
      }

      table {
        margin-top: 1rem;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid rgba(15, 40, 85, 0.08);
      }

      tbody tr:nth-child(even) {
        background-color: rgba(27, 100, 242, 0.04);
      }

      .timeline {
        margin-top: 1.5rem;
        border-left: 3px solid rgba(27, 100, 242, 0.2);
        padding-left: 1.25rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .timeline-item {
        position: relative;
        padding-left: 1rem;
      }

      .timeline-item::before {
        content: "";
        position: absolute;
        left: -1.5rem;
        top: 0.35rem;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background-color: #1b64f2;
      }

      .badge {
        display: inline-block;
        border-radius: 999px;
        padding: 0.25rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 600;
        background-color: rgba(16, 43, 106, 0.1);
        color: #102b6a;
        margin-left: 0.5rem;
      }

      footer {
        margin-top: 3rem;
        text-align: center;
        color: #556499;
      }

      .actions {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
      }
    </style>
  </head>
  <body>
    <header class="container">
      <article class="card">
        <div class="actions">
          <h1 style="margin-bottom: 0">Pedido de {{ order.customer_name }}</h1>
          <span class="status-pill" id="status-pill">
            <span class="material-symbols-outlined" aria-hidden="true">local_shipping</span>
            <span id="status-label">{{ order.get_status_display }}</span>
          </span>
        </div>
        <p style="margin-top: 1rem; color: #53608f">Consulta el avance del pedido en tiempo real. Puedes abrir la <a href="{% url 'order-control' %}">consola de control</a> en otra pestaña para simular cambios manuales y ver cómo se reflejan aquí.</p>
        <p style="margin-top: 0.5rem; font-size: 0.9rem; color: #7a88b8">
          Última actualización: <span id="last-updated">{{ order.updated_at|date:"d \d\e F \a \l\a\s H:i" }}</span>
        </p>
      </article>
    </header>

    <main class="container layout">
      <section class="card">
        <h2>Resumen del pedido</h2>
        <p style="margin-top: -0.5rem; color: #556499">
          Código interno <strong>#PO-2024-001</strong><br />
          Realizado el {{ order.created_at|date:"d \d\e F \a \l\a\s H:i" }}
        </p>
        <table role="grid">
          <thead>
            <tr>
              <th scope="col">Producto</th>
              <th scope="col">SKU</th>
              <th scope="col">Cantidad</th>
              <th scope="col">Precio unitario</th>
              <th scope="col">Subtotal</th>
            </tr>
          </thead>
          <tbody>
            {% for product in products %}
            <tr>
              <td>{{ product.name }}</td>
              <td>{{ product.sku }}</td>
              <td>{{ product.quantity }}</td>
              <td>${{ product.price|floatformat:2 }}</td>
              <td>${{ product.line_total|floatformat:2 }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <p style="margin-top: 1rem; font-weight: 600">Total estimado: ${{ order_total|floatformat:2 }}</p>
      </section>

      <section class="card">
        <h2>Estados del flujo</h2>
        <ul class="status-track" id="status-track">
          {% for value, label in status_choices %}
          <li data-status="{{ value }}">
            <span class="bullet">{{ forloop.counter }}</span>
            <div class="label">
              {{ label }}
              <small data-status-helper="{{ value }}">
                {% if forloop.first %}Preparando la orden en el local{% elif forloop.last %}Entrega completada{% else %}En logística y transporte{% endif %}
              </small>
            </div>
          </li>
          {% endfor %}
        </ul>

        <div class="timeline" id="timeline">
          <div class="timeline-item">
            <p>
              Pedido creado por {{ order.customer_name }}
              <span class="badge">{{ order.created_at|date:"H:i" }}</span>
            </p>
            <small style="color: #7a88b8">Esperando próximas actualizaciones…</small>
          </div>
        </div>
      </section>
    </main>

    <footer class="container">
      Visualización inspirada en herramientas de fulfillment modernas. <a href="{% url 'order-control' %}">Ir al panel de control manual</a>.
    </footer>

    <script>
      const statusLabel = document.getElementById("status-label");
      const statusTrack = document.getElementById("status-track");
      const timeline = document.getElementById("timeline");
      const lastUpdatedLabel = document.getElementById("last-updated");
      const formatter = new Intl.DateTimeFormat("es-AR", {
        dateStyle: "long",
        timeStyle: "short",
      });

      const history = [];

      function updateProgress(steps) {
        steps.forEach((step) => {
          const item = statusTrack.querySelector(`[data-status="${step.value}"]`);
          if (!item) return;
          item.classList.toggle("reached", step.reached);
        });
      }

      function pushHistory(statusDisplay, updatedAt) {
        if (history.length && history[history.length - 1].status === statusDisplay) {
          history[history.length - 1].updatedAt = updatedAt;
          renderTimeline();
          return;
        }
        history.push({ status: statusDisplay, updatedAt });
        renderTimeline();
      }

      function renderTimeline() {
        timeline.innerHTML = "";
        history
          .slice()
          .reverse()
          .forEach((item, index) => {
            const container = document.createElement("div");
            container.className = "timeline-item";
            const title = document.createElement("p");
            title.innerHTML = `Estado actualizado a <strong>${item.status}</strong><span class="badge">${item.updatedAt.toLocaleTimeString("es-AR", { hour: "2-digit", minute: "2-digit" })}</span>`;
            const detail = document.createElement("small");
            detail.style.color = "#7a88b8";
            detail.textContent = index === 0 ? "Último evento registrado." : "Evento anterior.";
            container.append(title, detail);
            timeline.appendChild(container);
          });
      }

      async function fetchStatus() {
        const response = await fetch("{% url 'order-status-data' %}");
        if (!response.ok) return;
        const data = await response.json();
        statusLabel.textContent = data.status_display;
        updateProgress(data.progress.steps);
        const updatedDate = new Date(data.updated_at);
        lastUpdatedLabel.textContent = formatter.format(updatedDate);
        pushHistory(data.status_display, updatedDate);
      }

      fetchStatus().catch((error) => console.error("Error al cargar estado", error));
      setInterval(() => {
        fetchStatus().catch((error) => console.error("Error al actualizar estado", error));
      }, 4000);
    </script>
  </body>
</html>
